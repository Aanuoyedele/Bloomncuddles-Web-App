generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Enum UserRole removed for SQLite compatibility
// Enum SubmissionStatus removed for SQLite compatibility

model School {
  id        String   @id @default(uuid())
  name      String
  email     String?
  address   String?
  
  // Branding
  logoUrl      String?
  primaryColor String?  @default("#486fa1")
  theme        String?  @default("light")  // light, dark, system
  
  // Academic settings
  academicYear String?  @default("2024-2025")
  currentTerm  String?  @default("Term 1")
  
  users         User[]
  classes       Class[]
  invites       Invite[]
  subscriptions Subscription[]
  payments      Payment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id              String    @id @default(uuid())
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])
  
  plan            String    // basic, premium, enterprise
  status          String    @default("inactive") // active, inactive, cancelled, past_due
  interval        String    @default("monthly") // monthly, yearly
  
  // Pricing (in kobo for Naira)
  amount          Int
  currency        String    @default("NGN")
  
  // Paystack references
  paystackSubscriptionCode String?
  paystackCustomerCode     String?
  paystackPlanCode         String?
  paystackAuthorizationCode String?
  
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  nextPaymentDate    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String   @id @default(uuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  
  amount    Int      // Amount in kobo
  currency  String   @default("NGN")
  status    String   @default("pending") // pending, success, failed
  
  // Paystack references
  paystackReference String   @unique
  paystackChannel   String?  // card, bank, ussd, etc.
  
  description String?
  paidAt      DateTime?
  
  createdAt DateTime @default(now())
}
model Invite {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  role      String   @default("TEACHER") // TEACHER, ADMIN
  used      Boolean  @default(false)
  expiresAt DateTime
  
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  
  createdById String
  
  createdAt DateTime @default(now())
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   // Was UserRole
  address   String?
  phone     String?
  
  // Status tracking
  isActive    Boolean  @default(true)
  lastLoginAt DateTime?
  
  schoolId  String?
  school    School?  @relation(fields: [schoolId], references: [id])
  
  // Teacher Relations
  classesTaught Class[]

  // Parent Relations
  children  ParentStudent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Class {
  id        String   @id @default(uuid())
  name      String
  grade     String
  schedule  String?  // e.g. "Mon, Wed 9:00 AM"

  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])

  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id])

  students  Student[]
  assignments Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id        String   @id @default(uuid())
  name      String
  grade     String
  dob       DateTime?
  
  // Login credentials (optional - set when student is given access)
  email     String?  @unique
  password  String?
  
  classId   String
  class     Class    @relation(fields: [classId], references: [id])
  
  parents   ParentStudent[]
  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Join table for Parent-Student (Many-to-Many)
model ParentStudent {
  id        String   @id @default(uuid())
  parentId  String
  parent    User     @relation(fields: [parentId], references: [id])
  
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])

  @@unique([parentId, studentId])
}

model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime
  fileUrl     String?  // PDF/DOCX file URL
  
  classId   String
  class     Class    @relation(fields: [classId], references: [id])
  
  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Submission {
  id        String   @id @default(uuid())
  grade     String?
  score     Int?     // Numerical score (0-100)
  feedback  String?
  status    String   @default("PENDING") // PENDING, SUBMITTED, GRADED
  submittedAt DateTime?
  gradedAt    DateTime?

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  studentId    String
  student      Student    @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  
  createdAt DateTime @default(now())
}

// =============== GAMES ===============

model Game {
  id          String   @id @default(uuid())
  title       String
  description String
  subject     String   // Math, Phonics, English
  grade       String   // Primary 1, Primary 2, etc.
  imageUrl    String
  gameType    String   // drag_drop, match, quiz, counting, spelling
  isActive    Boolean  @default(true)
  
  assignments GameAssignment[]
  createdAt   DateTime @default(now())
}

model GameAssignment {
  id        String   @id @default(uuid())
  gameId    String
  game      Game     @relation(fields: [gameId], references: [id])
  
  // Assignment target (one of these)
  targetType  String   // grade, class, student
  targetGrade String?
  classId     String?
  studentId   String?
  
  assignedBy  String
  dueDate     DateTime?
  
  createdAt   DateTime @default(now())
}

// =============== LIBRARY ===============

model Book {
  id          String   @id @default(uuid())
  title       String
  author      String?
  description String?
  subject     String?  // Science, Math, Fiction, etc.
  level       String?  // Lvl 1, Lvl 2, etc.
  fileUrl     String   // PDF/DOCX file
  coverUrl    String?  // Cover image
  
  schoolId    String
  uploadedBy  String
  
  assignments BookAssignment[]
  createdAt   DateTime @default(now())
}

model BookAssignment {
  id        String   @id @default(uuid())
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id])
  
  targetType  String   // grade, class, student
  targetGrade String?
  classId     String?
  studentId   String?
  
  assignedBy  String
  
  createdAt   DateTime @default(now())
}

